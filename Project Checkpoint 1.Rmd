---
title: "Project Checkpoint 1"
author: "Marshall Graham"
date: "November 24, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#1
#Group members: Marshall, Zain, Colleen, Vishal

#2
#a. bikeshare patterns

#b. Research questions:
1. How do bikeshare usage patterns vary depending on weather compared to buses?
2. Is there a correlation between proximity of a Niceride station to a bus stop and usage patterns of the Niceride station?

#ALTERNATIVE QUESTIONS: 
-How do usage patterns of bikes and public transit vary from the norm on public holidays?
-Is metro transit usage affected when the bikeshare closes down for the year (or is it just seasonal)?

#Datasets we will use
Research question 1:
Data Source: metaweather
Data Description: weather patterns for a certain day in Minneapolis
Data Limitations: challenging to get at all 365 days with ease (without going through them one at a time)
Data dimensions: 71x15 (for one day,)

Data Source: Nextrip data from Metrotransit
Data Description: 
Data Limitations:
Data dimensions:

Data Source: Niceride 2016 data
Data Description:
Data Limitations:
Data dimensions: >432,284x8

```{r}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(urltools)
library(jsonlite)
library(ggmap)
library(rvest)

```




Read in data on NiceRide, the bike share for the twin cities
```{r, cache=TRUE}

niceRide2016<-read_csv("Nice_ride_data_2016_season\\Nice_ride_data_2016_season\\Nice_ride_trip_history_2016_season.csv")
niceRideLocations<-read_csv("Nice_ride_data_2016_season\\Nice_ride_data_2016_season\\Nice_Ride_2016_Station_Locations.csv")

```

Read in data on MetroTransit
```{r, cache=TRUE}
metroStops<-read_csv("bus-stops-Oct-2017.csv")
metroRidership<-read_csv("ridership-route-day-Jan2014-Oct2017.csv")

```


Visualize where the bus stops and bike stations are in the twin cities
```{r, cache=TRUE}
twinCitiesMap<-get_map(location="Minneapolis", zoom= 10)

ggmap(twinCitiesMap)+
   geom_point(data=metroStops, aes(x=site_longitude, y=site_latitude))


#about 100 ft in degrees latitude
ft100<-.0002744

ggmap(twinCitiesMap)+
   geom_point(data=niceRideLocations, aes(x=Longitude, y=Latitude))


```

Limit the bus stops to only stops within a rectangle that encloses the bike stations
```{r}
minBikeLat<-min(niceRideLocations$Latitude)-ft100
maxBikeLat<-max(niceRideLocations$Latitude)+ft100

minBikeLong<-min(niceRideLocations$Longitude)-ft100
maxBikeLong<-max(niceRideLocations$Longitude)+ft100


#Only bus stops within square
metroStopsLimited<-metroStops%>%
   filter(site_longitude>minBikeLong&site_longitude<maxBikeLong)%>%
   filter(site_latitude>minBikeLat&site_latitude<maxBikeLat)
```


Look at new map to make sure it's right
```{r}

ggmap(twinCitiesMap)+
   geom_point(data=metroStopsLimited, aes(x=site_longitude, y=site_latitude))
#Check number of stops, see if step was useful in reducing size of data set
nrow(metroStopsLimited)

```

#Weather analysis

Read in data on weather for 2016
```{r, cache=TRUE}

#source: http://www.dnr.state.mn.us/climate/twin_cities/listings.html
#Had to copy and paste data from page into .txt file and read that in
MinneapolisWeather<-read_csv(file="Minneapolis Weather.txt", col_names = c("date", "maxTemp","minTemp","precip","snow","snowDepth"))
```


Clean up data
```{r}
MinneapolisWeather<-MinneapolisWeather%>%
   mutate(precip=as.double(replace(precip,precip=="T",0)))%>%
   mutate(snow=as.double(replace(snow,snow=="T",0)))%>%
   mutate(snowDepth=as.double(replace(snowDepth,snowDepth=="T",0)))

```

Show daily ridership from 2014-2017 overall
```{r}

#change date variable type to Date object
metroRidership<-metroRidership%>%
   mutate(dtDate=as.Date(dtDate))

#Calculate total number of riders for a given day, while still keeping data on what type of riding day it was (Holiday, weekday, etc.)
metroRidershipTotal<-metroRidership%>%
   group_by(dtDate)%>%
   summarize(totalRiders=sum(Total_Riders))%>%
   left_join(metroRidership, by="dtDate")%>%
   select(dtDate, totalRiders, Schedule)

#Show graph of total ridership for each day
ggplot(metroRidershipTotal, aes(x=dtDate, y=totalRiders, color=Schedule))+
   geom_point()

```


Show how divergence from daily mean effects ridership (only work with 2016 because thats time frame for nice ride data)
```{r}

#Add weather data to info on bus ridership
WeatherRiders<-metroRidership%>%
   left_join(MinneapolisWeather, by=c("dtDate"="date"))%>%
   filter(dtDate>="2016-01-01"&dtDate<="2016-12-31")#fix date object type


#Calculate the average temperature of a day over the seven years of weather data
#Should replace this with climate normals from NOAA
AvgDayTemp<-MinneapolisWeather%>%
   mutate(day=yday(date))%>%
   group_by(day)%>%
   summarize(dayTemp=sum((maxTemp+minTemp)/2)/n())

#Check that its 366 elements
nrow(AvgDayTemp)

#Calculate the difference between the average temperature of a day and the mean average temperature of that day over the seven years of weather data 
WeatherRiders<-WeatherRiders%>%
   mutate(day=yday(dtDate))%>%
   left_join(AvgDayTemp, by="day")%>%
   mutate(tempDiff=(maxTemp+minTemp)/2-dayTemp)

WeatherRidersTotal<-WeatherRiders%>%
   mutate(day=as.factor(day), Route=as.factor(Route))%>%
   group_by(dtDate, tempDiff, dayTemp)%>%
   summarize(Total_Riders=sum(Total_Riders))

#Check that it worked
head(WeatherRidersTotal)




```


Visualization of how ridership is dependent on temperature of a day and how it depends on divergence from historical temperature on that day
```{r}

#Group together all the riders on the different routes while keeping temp data

ggplot(WeatherRidersTotal, aes(x=dayTemp, y=Total_Riders))+
   geom_smooth()
```

We see that ridrship does correlate wtih absolute temperature peaking at around 50 degrees F
```{r}
ggplot(WeatherRidersTotal, aes(x=tempDiff, y=Total_Riders))+
   geom_smooth()

```

Ridership drops off significantly on days where weather is significantly colder than norms, and is approximately constant for temps above norms


##Doing same weather analysis with ridership
First get ridership of bikes by day

```{r}

#clean up date variable in data and total riders on that date
niceRideDay<-niceRide2016%>%
   mutate(startDate=niceRide2016$`Start date`)%>%
   select("startDate")%>%
   mutate(startDate=as.Date(startDate, "%m/%d/%Y"))%>%
   group_by(startDate)%>%
   summarize(numRiders=n())



#Check that it worked
head(niceRideDay)

#Add weather data to NiceRide data, including divergence from normals
niceRideDay<-niceRideDay%>%
   left_join(MinneapolisWeather, by=c("startDate"="date"))%>%
   mutate(day=yday(startDate))%>%
   left_join(AvgDayTemp,by="day")%>% 
   mutate(tempDiff=(maxTemp+minTemp)/2-dayTemp)

#Check that it worked
head(niceRideDay)


```

Look at how NiceRide ridership correlates to temperature
```{R}
ggplot(niceRideDay, aes(x=dayTemp, y=numRiders))+
   geom_smooth()
   
```

Unsuprisingly, more people ride bikes in warmer weather

Now look at how ridership correlates to departure from climate normals
```{R}
ggplot(niceRideDay, aes(x=tempDiff, y=numRiders))+
   geom_smooth()

```
People ride much less on days with much lower temperatures than normals, and more on days higher than normals



